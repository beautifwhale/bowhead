{"version":3,"file":"bowhead-functions.js","sources":["../src/utils/firebase.js","../src/utils/constants.js","../src/utils/webhook-stripe-utils.js","../src/index.js"],"sourcesContent":["import admin from 'firebase-admin';\n\nconst firebase = (config) => {\n\n    const projectId = config.projectId\n    const privateKey = config.privateKey\n    const clientEmail = config.clientEmail\n    const databaseProductionUrl = config.databaseProductionUrl\n\n    if (admin.apps && !admin.apps.length) {\n        admin.initializeApp({\n            credential: admin.credential.cert({\n                \"project_id\": projectId,\n                \"private_key\": privateKey?.replace(/\\\\n/g, '\\n'),\n                \"client_email\": clientEmail\n            }),\n            databaseURL: databaseProductionUrl\n        });\n\n        if (process.env.NODE_ENV === 'development') {\n            admin.firestore().settings({\n                host: \"localhost:8080\",\n                ssl: false\n            });\n        }\n    }\n\n\n    const verifyToken = async (idToken) => {\n        try {\n            let decodedToken = await admin.auth().verifyIdToken(idToken)\n            return decodedToken\n        } catch (err) {\n            // invalid token\n            return null\n        }\n    }\n\n    const firestore = admin.firestore();\n\n    return { firestore, verifyToken }\n}\n\n\nexport { firebase };\n","export const STRIPE_SUBSCRIPTION_STATUS = {\n  TRIALING: 'trialing',\n  ACTIVE: 'active',\n  CANCELLED: 'canceled'\n}\n","import { STRIPE_SUBSCRIPTION_STATUS } from './constants';\n\nconst isValidStatus = (status) => {\n  return status === STRIPE_SUBSCRIPTION_STATUS.TRIALING ||\n    status === STRIPE_SUBSCRIPTION_STATUS.ACTIVE ||\n    status === STRIPE_SUBSCRIPTION_STATUS.CANCELLED\n}\n\nexport const dbUpdateSubscriptionByCustomerId = async (firestore, data) => {\n  const stripeCustomerId = data.customer || null;\n  const status = data.status || null;\n  const planId = data.plan.id || null;\n  const interval = data.plan.interval || null;\n\n  if (isValidStatus(status) && stripeCustomerId && planId && interval) {\n    if (status === STRIPE_SUBSCRIPTION_STATUS.CANCELLED) {\n      // delete stripe customer data from DB\n      await firestore.collection(\"stripe\").doc(stripeCustomerId).delete();\n    } else {\n      // update stripe customer data in DB\n      await firestore.collection(\"stripe\").doc(stripeCustomerId).set({ status, planId, interval }, { merge: true });\n    }\n  }\n}\n\nexport const dbUpdateCustomerData = (firestore, data) => {\n\n  const stripeCustomerId = data.customer || null;\n  const uid = data.client_reference_id || null;\n\n  if (stripeCustomerId && uid) {\n\n    const userRef = firestore.collection(\"users\").doc(uid);\n    const batch = firestore.batch();\n\n    // user\n    batch.set(\n      userRef,\n      {\n        stripeCustomerId\n      },\n      { merge: true }\n    );\n\n\n    // stripe\n    const stripeRef = firestore.collection(\"stripe\").doc(stripeCustomerId);\n    batch.set(\n      stripeRef,\n      {\n        uid\n      },\n      { merge: true }\n    );\n\n    return batch.commit()\n  } else {\n    throw new Error(`dbUpdateCustomerData(): stripeCustomerId: ${stripeCustomerId} uid:${uid}`)\n  }\n}","import { firebase } from './utils/firebase';\nimport Stripe from 'stripe'\nimport { dbUpdateSubscriptionByCustomerId, dbUpdateCustomerData } from './utils/webhook-stripe-utils'\n\nclass BowheadFunctions {\n\n    constructor(config) {\n        // singleton\n        if (BowheadFunctions._instance) {\n            return BowheadFunctions._instance;\n        }\n        BowheadFunctions._instance = this;\n\n        this._firebase = firebase(config.firebase)\n        this._firestore = this._firebase.firestore\n        this._stripeWebhookSigningSecret = config.stripe.stripeWebhookSigningSecret\n        this._stripe = Stripe(config.stripe.stripeSecretKey, {\n            maxNetworkRetries: 3, // Retry a request X times before giving up\n        });\n    }\n\n    _requestUnauthourised() {\n        return { error: 'Error: request unauthorised', data: { statusCode: 401 } }\n    }\n\n    async webhookStripe({ stripeSignature, rawBody }) {\n\n        let verifiedEvent;\n        try {\n            verifiedEvent = this._stripe.webhooks.constructEvent(rawBody, stripeSignature, this._stripeWebhookSigningSecret);\n        } catch (error) {\n            // invalid event            \n            return Promise.reject(error.message)\n        }\n\n        switch (verifiedEvent.type) {\n            case 'customer.subscription.created':\n                await dbUpdateSubscriptionByCustomerId(this._firestore, verifiedEvent.data.object)\n                break;\n            case 'customer.subscription.updated':\n                await dbUpdateSubscriptionByCustomerId(this._firestore, verifiedEvent.data.object)\n                break;\n            case 'customer.subscription.deleted':\n                await dbUpdateSubscriptionByCustomerId(this._firestore, verifiedEvent.data.object)\n                break;\n            case 'checkout.session.completed':\n                await dbUpdateCustomerData(this._firestore, verifiedEvent.data.object)\n                break;\n            default:\n                // unexpected event type\n                return Promise.resolve('unexpected event type');\n        }\n\n        return Promise.resolve('webhook done');\n    }\n\n    async deleteStripeCustomer({ token, data }) {\n        const user = await this._firebase.verifyToken(token);\n        const stripeCustomerId = data?.stripeCustomerId;\n        // todo validate data\n        if (!user) return this._requestUnauthourised()\n        return await this._stripe.customers.del(stripeCustomerId);\n    }\n\n    async createStripeCustomerPortalSession({ token, data }) {\n        const user = await this._firebase.verifyToken(token);\n        // todo validate data\n        if (!user) return this._requestUnauthourised()\n        return await this._stripe.billingPortal.sessions.create(data).then((session) => session);\n    }\n\n    async createStripeCheckoutSession({ token, data }) {\n        const user = await this._firebase.verifyToken(token);\n        // todo validate data\n        if (!user) return this._requestUnauthourised()\n\n        // do not provide a free trial if the user has previously signed up\n        data?.customer && delete data?.subscription_data;\n\n        return await this._stripe.checkout.sessions.create(data).then((session) => session)\n    }\n\n}\n\nexport default BowheadFunctions"],"names":["_catch","body","recover","result","e","then","firebase","config","projectId","privateKey","clientEmail","databaseProductionUrl","admin","apps","length","initializeApp","credential","cert","replace","databaseURL","process","env","NODE_ENV","firestore","settings","host","ssl","verifyToken","idToken","auth","verifyIdToken","STRIPE_SUBSCRIPTION_STATUS","TRIALING","ACTIVE","CANCELLED","isValidStatus","status","dbUpdateSubscriptionByCustomerId","data","stripeCustomerId","customer","planId","plan","id","interval","collection","doc","delete","set","merge","dbUpdateCustomerData","uid","client_reference_id","userRef","batch","stripeRef","commit","Error","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","discriminant","cases","dispatchIndex","awaitBody","outer","i","test","testValue","fallthroughCheck","reject","_resumeAfterBody","_resumeAfterTest","BowheadFunctions","constructor","_instance","_firebase","_firestore","_stripeWebhookSigningSecret","stripe","stripeWebhookSigningSecret","_stripe","Stripe","stripeSecretKey","maxNetworkRetries","_requestUnauthourised","error","statusCode","webhookStripe","stripeSignature","rawBody","Promise","resolve","verifiedEvent","webhooks","constructEvent","message","type","object","deleteStripeCustomer","token","user","customers","del","createStripeCustomerPortalSession","billingPortal","sessions","create","session","createStripeCheckoutSession","subscription_data","checkout"],"mappings":"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"}